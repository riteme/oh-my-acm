 字符集较大时考虑 `map` 或者字符二进制化。`mcnt` 是已分配的状态数，最大为 $2n-1$，转移边数量最多为 $3n-4$。`cnt` 表示该状态的 right 集合的大小，需要使用 `tsort` 和 `subsum` 来计算具体值。`first` 表示该状态第一次出现时的右端点，right 集合可以由 fail 树上子树内所有 `first` 的并得到。如果是复制出来的节点，其 `first` 会重复。自动机的根是 1。

![](assets/sam.svg)

区间内本质不同字串个数：先建 SAM，然后扫描线。当扫到右端点 $r$ 时，SAM 上的状态为 $x$，则需要将 $x$ 在 fail 树上到根的每个节点更新 right。这里需要用 LCT 和线段树。LCT 上的一段的右端点是一样的，因此可以集体更新。复杂度 $\mathrm O(n\log^2 n)$。